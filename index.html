<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>ChromicDuo EmeraldFuture</title>
    <script src="./src/p5.min.js"></script>
    <script src="./src/p5.dom.min.js"></script>
    <script src="./src/p5.sound.js"></script>

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="play-all-model-animation.js"></script>
    <script src="./src/displacement-offset-shader.js"></script>

    <style src="style.css"></style>
</head>

<body>


    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">

        <a-assets>
            <img id="water-normal"
                src="//raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/waternormals.jpg"
                crossorigin="anonymous" />

            <img id="boxTexture" src="https://i.imgur.com/mYmmbrp.jpg">
            <img id="skyTexture" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg">
            <img id="groundTexture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
            <a-asset-item id="flower" src="./assets/flower/scene.gltf"></a-asset-item>
            <a-asset-item id="bird" src="./assets/bird/scene.gltf"></a-asset-item>
            <a-asset-item id="butterfly" src="./assets/butterfly/butterfly.gltf"></a-asset-item>

        </a-assets>

        <a-entity id="newEntity" rotation="180 90 0" scale="2"
            animation="property: rotation; to: 20 -360 -180; loop: true; dur: 50000">
        </a-entity>

        <a-light type="ambient" intensity="1" color="#445451"></a-light>
        <a-light type="area" intensity="0.2" position="2 4 4"></a-light>

        <a-camera gps-camera rotation-reader> </a-camera>
    </a-scene>


</body>



<script>
    let song;
    let fft, filter, spectrum, level, soundfile, amplitude, scaleVal;

    function preload() {
        song = loadSound('./assets/Point10.mp3');
    }

    function setup() {
        song.play();
        //song.loop(); // song is ready to play during setup() because it was loaded during preload
        fft = new p5.FFT();
        amplitude = new p5.Amplitude();
        soundfile = new p5.SoundFile();
        randX = random(-20, 30);
        randY = random(-5, 15);
        randZ = random(-20, 20);
    }

    function showCredits() {
        console.log("thank you for listening");
    }
    //create a new entity in the scene 
    function draw() {

        // frameRate(2);
        spectrum = fft.analyze();
        level = amplitude.getLevel();
        console.log('level is ', level);
        // map the value to the following value for scale? can increase the speed of rotation too? 
        // when the scaleval is up, the amount of stuff gets x times more 
        scaleVal = map(level, 0, 1, 1.5, 10); //mostly 1- 6 
        console.log("scaleval is ", scaleVal);
        populate(scaleVal);
        song.onended(showCredits); // it works 

    }

    let set = 10;
    let newEntity = document.getElementById('newEntity');

    let sphere = document.createElement('a-sphere'); //creating child for entity 
    let anim = document.createElement('a-animation');
    sphere = document.createElement('a-sphere'); //creating child for entity 
    anim = document.createElement('a-animation');
    sphere1 = document.createElement('a-sphere'); //creating child for entity 
    anim1 = document.createElement('a-animation');
    sphere2 = document.createElement('a-sphere'); //creating child for entity 
    anim2 = document.createElement('a-animation');
    sphere3 = document.createElement('a-sphere'); //creating child for entity 
    anim3 = document.createElement('a-animation');
    sphere4 = document.createElement('a-sphere'); //creating child for entity 
    anim4 = document.createElement('a-animation');
    sphere5 = document.createElement('a-sphere'); //creating child for entity 
    anim5 = document.createElement('a-animation');
    sphere6 = document.createElement('a-sphere'); //creating child for entity 
    anim6 = document.createElement('a-animation');
    sphere7 = document.createElement('a-sphere'); //creating child for entity 
    anim7 = document.createElement('a-animation');

    let animations = [anim,anim1,anim2,anim3,anim4,anim5,anim6,anim7];
    let spheres = [sphere,sphere1,sphere2,sphere3,sphere4,sphere5,sphere6,sphere7];

    // let spheres =[sphere,sphere1,sphere2,sphere3];
    // let animations =[anim,anim1,anim2,anim3];

    function Sphere(sphere, anim, scaleVal, delayTime, randX, randY, randZ) {

        sphere.id = "sphere";
        sphere.object3D.position.set(randX, randY, randZ);
        sphere.object3D.scale.set(scaleVal, scaleVal, scaleVal);
        sphere.setAttribute('material', 'shader: displacement-offset');
        sphere.setAttribute('segment-height', 50 * scaleVal);
        sphere.setAttribute('segment-width', 50 * scaleVal);
        // sphere.setAttribute('scale', '1 1 1 ');
        sphere.setAttribute('myoffset-updater');
        sphere.setAttribute('material', 'shader: displacement-offset');
        anim.setAttribute('direction', 'alternate-reverse');
        anim.setAttribute('attribute', 'rotation');
        anim.setAttribute('dur', 50 * scaleVal); // could be slower 
        anim.setAttribute('from', '1 1 1'); // could be slower 
        anim.setAttribute('to', `${scaleVal},${scaleVal},${scaleVal}`); // could be slower 
        anim.setAttribute('repeat', '0'); // could be slower 
        anim.setAttribute('easing', 'indefinite'); // could be slower 
        anim.setAttribute('delay', 5000 * delayTime); // could be slower 

        sphere.appendChild(anim);
    }


    // can create different shapes and set it up at differnt times 

    function populate(scaleVal) {


        let delayTime = 2 * scaleVal;

        if (scaleVal < 3) {
            Sphere(sphere, anim, scaleVal, delayTime, 5 * randX, 0, 0);
            Sphere(sphere1, anim1, scaleVal / 2, delayTime, 3, 2 * randY, 0);
            Sphere(sphere2, anim2, scaleVal / 3, delayTime, 0, 8, randZ);
            Sphere(sphere3, anim3, scaleVal, delayTime * 3, 2 - randX, 8, 0);
        } else {
            Sphere(sphere, anim, scaleVal, delayTime, 5 * randX, 0, 0);
            Sphere(sphere1, anim1, scaleVal / 2, delayTime, 3, 2 * randY, 0);
            Sphere(sphere2, anim2, scaleVal / 3, delayTime, 0, 8, randZ);
            Sphere(sphere3, anim3, scaleVal, delayTime * 3, 2 - randX, 8, 20);
            Sphere(sphere4, anim4, scaleVal, delayTime, 10 * randX, randZ, randY);
            Sphere(sphere5, anim5, scaleVal / 2, delayTime, -3, 3 * randY, -2);
            Sphere(sphere6, anim6, scaleVal / 3, delayTime, 10, 8, randZ);
            Sphere(sphere7, anim7, scaleVal, delayTime * 3, 2 - randX, 8, -20);
        }


    }

    spheres.forEach(element => {
        newEntity.appendChild(element);
    });


    

    AFRAME.registerComponent('modify-materials', {
        init: function () {
            // Wait for model to load.
            this.el.addEventListener('model-loaded', () => {
                // Grab the mesh / scene.
                const obj = this.el.getObject3D('mesh');
                // Go over the submeshes and modify materials we want.
                obj.traverse(node => {
                    if (node.name.indexOf('ship') !== -1) {
                        // node.material.color.set('red');
                    }

                });
            });
        }
    });
</script>

</html>